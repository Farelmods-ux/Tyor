<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparta V0.1 - Bug Service</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==?" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
<style>
    /* CSS umum */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
        background: black; 
        font-family: 'Poppins', sans-serif; 
        color: white; 
        /* KUNCI PENTING: Mencegah body scroll saat keyboard muncul */
        height: 100vh; /* Pastikan body mengambil tinggi penuh viewport */
        overflow: hidden; /* Mencegah scroll pada body */
        /* END KUNCI PENTING */
        
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative; 
        padding-bottom: 70px; 
    }
    
    /* Konten utama harus fleksibel dan berada di atas navbar */
    .content { 
        padding: 20px; 
        width: 100%;
        max-width: 500px;
        flex-grow: 1; 
        display: flex;
        justify-content: center;
        align-items: flex-start;
        /* KUNCI PENTING: Jika konten terlalu panjang, content yang scroll */
        overflow-y: auto; 
        /* END KUNCI PENTING */
    }
    
    /* --- Custom Header Styles (Top Bar) --- */
    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        width: 100%;
        background: black;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .header-title {
        font-size: 20px;
        font-weight: 800;
        color: #1B47F1;
        text-shadow: 0 0 5px #0917D7;
    }

    /* GANTI: Icon di header menjadi link/favicon website */
    .header-logo-link {
        display: block;
        width: 24px;
        height: 24px;
    }
    
    .header-logo-link img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* --- Main Card --- */
    .main-card {
        background: linear-gradient(180deg, #1c1c1c 0%, #101010 100%);
        padding: 30px 20px;
        margin-top: 20px;
        border-radius: 15px;
        width: 100%;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
        border: 1px solid #333;
        text-align: center;
        position: relative;
    }
    
    .logo-container { 
        margin-bottom: 25px; 
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100px; 
    }

    .service-gif { 
        width: 100%; 
        max-width: 250px; 
        height: auto; 
        object-fit: cover; 
        border-radius: 8px; 
        box-shadow: 0 0 15px rgba(27, 71, 241, 0.7); 
    }

    .user-info-display { 
        background-color: #2a2a2a; 
        padding: 15px; 
        border-radius: 10px; 
        margin-bottom: 25px; 
        border: 1px solid #444; 
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
    }
    
    .username-text { 
        font-size: 18px; 
        font-weight: 800; 
        color: white; 
        margin-bottom: 10px; 
    }
    
    .role-exp-text { 
        font-size: 13px; 
        color: #B3C0FF; 
        font-weight: 500;
    }
    
    .target-section { 
        margin-bottom: 25px; 
    }
    
    .target-section h4 { 
        color: white; 
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 16px;
        text-align: left; 
    }
    
    .input-group {
        display: flex;
        align-items: center; 
        background-color: #0d0d0d; 
        border: 1px solid #333; 
        border-radius: 8px; 
        padding: 5px 15px; 
    }

    .input-group span {
        color: #B3C0FF; 
        font-size: 16px; 
        font-weight: 600; 
        margin-right: 10px;
    }
    
    .target-input { 
        flex-grow: 1; 
        background: none; 
        border: none; 
        color: white; 
        font-size: 16px; 
        padding: 8px 0; 
        outline: none; 
        font-family: 'Poppins', sans-serif;
    }
    
    .action-button { 
        width: 100%; 
        padding: 12px; 
        border-radius: 8px; 
        font-size: 16px; 
        font-weight: 700; 
        cursor: pointer; 
        transition: background-color 0.2s, 
        transform 0.1s; 
        margin-bottom: 15px; 
        border: none; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
    }
    
    .select-service-btn {
        background-color: #333; 
        color: white;
        border: 1px solid #555; 
    }
    
    .select-service-btn:hover {
        background-color: #444; 
    }
    
    .send-service-btn { 
        background: linear-gradient(90deg, #F81CF8 0%, #B900FF 100%); 
        color: white; 
        box-shadow: 0 4px 15px rgba(185, 0, 255, 0.4); 
    }
    
    .send-service-btn:hover { 
        background: linear-gradient(90deg, #FF45FF 0%, #D41AFF 100%); 
        transform: translateY(-1px); 
    }
    
    .send-service-btn i { margin-right: 10px; font-size: 18px; }

    /* Dropdown / Modal untuk Select Bug */
    #service-selection-list {
        display: none;
        position: absolute;
        width: calc(100% - 40px);
        left: 50%;
        transform: translateX(-50%);
        top: 360px; /* Nilai diatur agar ada di bawah Select Bug Button */
        background: #1c1c1c;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.8);
        z-index: 500;
        overflow: hidden;
    }

    .service-option { 
        padding: 12px 20px; 
        cursor: pointer; 
        color: #ccc; 
        border-bottom: 1px solid #333; 
        text-align: left; 
        transition: background-color 0.2s; 
    }
    
    .service-option:last-child { 
        border-bottom: none;
    }
 
    .service-option:hover { 
        background-color: #0917D7; 
        color: white; 
    }

    /* Notifikasi & Modal Kustom - DISAMAKAN DENGAN DASHBOARD */
    #custom-modal { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); 
        display: none; justify-content: center; align-items: center; z-index: 99999; /* NEW: Z-index lebih tinggi */
        opacity: 0; transition: opacity 0.3s ease;
        pointer-events: none; /* NEW: Mencegah stuck */
    }
    
    .custom-modal.show { 
        opacity: 1; 
        display: flex;
        pointer-events: auto; /* NEW: Aktifkan saat tampil */
    }
    
    .modal-content { 
        background: #1a1a1a; padding: 25px; border-radius: 12px; width: 90%; max-width: 300px; 
        border: 2px solid #1B47F1; 
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); text-align: center; 
    }
    
    .modal-content h3 { color: #1B47F1; margin-bottom: 15px; font-size: 18px; }
    .modal-content p { color: #ccc; margin-bottom: 20px; font-size: 14px; }
    
    .modal-content button { 
        background-color: #1B47F1; color: white; border: none; padding: 10px 20px; border-radius: 6px; 
        cursor: pointer; font-weight: 600; transition: background-color 0.3s;
    }
    
    .modal-content button:hover { background-color: #0917D7; }
    
    /* --- Bottom Navigation Bar (Navbar Full) --- */
    .navbar-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        display: flex;
        justify-content: space-around;
        align-items: center;
        height: 60px;
        background: #0d0d0d;
        border-top: 3px solid #1B47F1; 
        z-index: 200;
        padding-bottom: env(safe-area-inset-bottom, 0); 
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #777; 
        text-decoration: none;
        font-size: 14px; 
        font-weight: 500;
        cursor: pointer;
        transition: color 0.2s;
        padding: 5px;
        width: 25%; 
    }

    .nav-icon {
        font-size: 24px;
        color: #404040;
        margin-bottom: 4px;
        transition: color 0.3s;
    }
    
    .nav-text {
         color: #B3C0FF;
    }

    /* Status Aktif */
    .nav-item.active .nav-icon {
        color: #1B47F1; 
        text-shadow: 0 0 5px #1B47F1;
    }

    /* Area mobile (supaya navbar tetap di tengah) */
    @media (min-width: 500px) {
        .navbar-container {
            left: 50%;
            transform: translateX(-50%);
        }
    }
</style>
</head>

<body>
    <div id="custom-modal" class="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <button onclick="closeCustomModal()">OK</button>
        </div>
    </div>

    <div class="header-top">
        <div class="header-title">Sparta V0.1</div>
        <i class="fas fa-user-circle header-icon"></i>
        </div>
    </div>
    
    <div class="content">
        
        <div class="main-card">
            
            <div class="logo-container">
                <video src="https://files.catbox.moe/vzmw6r.mp4" class="service-gif" autoplay loop muted playsinline></video>
            </div>

            <div class="user-info-display">
                <div class="username-text" id="user-display-username">user</div>
                <div class="role-exp-text" id="user-display-role-exp">Role: Member â€¢ Exp: YYYY-MM-DD</div>
            </div>
            
            <div class="target-section">
                <h4>Target Number</h4>
                <div class="input-group">
                    <span>+62</span>
                    <input type="number" id="target-number" class="target-input" placeholder="821xxxxxx" pattern="\d*" tabindex="-1">
                </div>
            </div>
            
            <button id="select-service-btn" class="action-button select-service-btn">
                Select Bug <i class="fas fa-chevron-down" style="margin-left: 10px;"></i>
            </button>
            
            <button id="send-service-btn" class="action-button send-service-btn">
                <i class="fas fa-bolt"></i> SEND BUG
            </button>

            <div id="service-selection-list">
                <div class="service-option" data-service="bug1">BUG1</div>
                <div class="service-option" data-service="bug2">BUG2</div>
                <div class="service-option" data-service="bug3">BUG3</div>
            </div>
        </div>
        
    </div>

    <div class="navbar-container">
        <div class="nav-item" onclick="window.location.href='dashboard.html'" data-text="Home">
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-text">Home</span>
        </div>
        
        <div class="nav-item active" data-text="Bug">
            <i class="fas fa-phone-alt nav-icon"></i>
            <span class="nav-text">Bug</span>
        </div>
        
        <div class="nav-item" onclick="showCustomModal('Fitur Tools belum tersedia.', 'Informasi')" data-text="Tools">
            <i class="fas fa-bolt nav-icon"></i>
            <span class="nav-text">Tools</span>
        </div>
        
        <div class="nav-item" onclick="showCustomModal('Fitur Chat belum tersedia.', 'Informasi')" data-text="Chat">
            <i class="fas fa-comment nav-icon"></i>
            <span class="nav-text">Chat</span>
        </div>
    </div>

<script>
    // --- KONFIGURASI FIREBASE ---
    // Variabel global (disediakan oleh platform)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    
    let firebaseConfig = {};
    try {
        firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    } catch (e) {
        console.error("Firebase config is invalid JSON:", e);
    }
    
    if (Object.keys(firebaseConfig).length > 0) {
        try {
             if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully.");
             }
        } catch (error) {
            console.warn("Firebase initialization failed:", error);
        }
    } else {
        console.warn("Firebase configuration not found/empty.");
    }
    
    // --- FUNGSI UTILITY ---

    function logout() {
        localStorage.removeItem('userSession');
        localStorage.removeItem('app_session'); 
        window.location.replace("index.html"); 
    }

    // Fungsi untuk mengambil data sesi dari localStorage
    function getSession() {
        try {
            const sessionStr = localStorage.getItem('userSession') || localStorage.getItem('app_session');
            if (sessionStr) {
                const session = JSON.parse(sessionStr);
                
                if (!session.username || !session.loginAt) {
                    console.error("Session data incomplete.");
                    logout();
                    return null;
                }

                if (session.expiresAt !== Infinity && session.expiresAt != null && session.expiresAt <= Date.now()) {
                    console.log("Session expired.");
                    logout(); 
                    return null; 
                }
                return session;
            }
        } catch (error) {
            console.error("Error reading or parsing session:", error);
            logout(); 
        }
        return null;
    }

    // Fungsi untuk menampilkan modal kustom
    function showCustomModal(message, title = 'Notification', isError = false) {
        const modalElement = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalButton = modalElement.querySelector('button');
        
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalButton.onclick = closeCustomModal; // Reset tombol OK

        // Sesuaikan warna border
        let color = isError ? '#ff4444' : '#1B47F1';
        // NEW: Jika DONE BUG, gunakan warna yang berbeda
        if (title === 'DONE BUGðŸ”¥') {
             color = '#F81CF8';
        }
        
        modalElement.querySelector('.modal-content').style.borderColor = color;
        modalTitle.style.color = color;
        modalButton.style.backgroundColor = color;

        modalElement.classList.add('show');
        modalElement.style.display = 'flex';
        modalElement.style.pointerEvents = 'auto'; // Pastikan modal bisa diklik
    }

    function closeCustomModal() {
        const modalElement = document.getElementById('custom-modal');
        modalElement.classList.remove('show');
        modalElement.style.pointerEvents = 'none'; // NEW: Matikan pointer events setelah tertutup
        setTimeout(() => { modalElement.style.display = 'none'; }, 300);
    }
    
    // Fungsi untuk menghitung dan memformat tanggal Exp
    function formatExpiryDate(session) {
        if (!session || !session.loginAt || session.expiresAt === undefined) return 'N/A';
        
        const durasi = session.durasi ? session.durasi.toLowerCase() : '';
        
        if (durasi === 'permanent') {
            return '9999-99-99';
        }

        const match = durasi.match(/^(\d+)d$/i); 
        
        if (match) {
            const months = parseInt(match[1], 10);
            
            const baseDate = new Date(session.loginAt); 
            const expiryDate = new Date(baseDate);
            expiryDate.setMonth(expiryDate.getMonth() + months);
            
            const year = expiryDate.getFullYear();
            const month = String(expiryDate.getMonth() + 1).padStart(2, '0'); 
            const day = String(expiryDate.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        } 
        
        if (session.expiresAt !== Infinity && session.expiresAt != null) {
            const expiryDate = new Date(session.expiresAt);
            const year = expiryDate.getFullYear();
            const month = String(expiryDate.getMonth() + 1).padStart(2, '0');
            const day = String(expiryDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        return 'N/A';
    }


    // --- LOGIKA UTAMA SERVICE TOOL ---
    document.addEventListener('DOMContentLoaded', function () {
        // --- Cek Sesi Pertama ---
        const session = getSession();
        
        if (!session) { return; } 

        // --- Inisialisasi DOM dan Event Handlers ---
        let selectedService = ''; 
        const serviceSelections = {
            'bug1': 'BUG1',
            'bug2': 'BUG2',
            'bug3': 'BUG3'
        };
        
        const selectServiceBtn = document.getElementById('select-service-btn');
        const sendServiceBtn = document.getElementById('send-service-btn');
        const serviceSelectionList = document.getElementById('service-selection-list');
        const serviceOptions = document.querySelectorAll('.service-option');
        const targetNumberInput = document.getElementById('target-number');
        
        const userDisplayUsername = document.getElementById('user-display-username');
        const userDisplayRoleExp = document.getElementById('user-display-role-exp');
        
        // --- Tampilkan Info User ---
        const displayUsername = session.username ? session.username.charAt(0).toUpperCase() + session.username.slice(1) : 'N/A';
        const role = session.role ? session.role.charAt(0).toUpperCase() + session.role.slice(1) : 'Member';
        
        const expFormatted = formatExpiryDate(session); 

        userDisplayUsername.textContent = displayUsername;
        userDisplayRoleExp.textContent = `Role: ${role} â€¢ Exp: ${expFormatted}`;
        
        selectServiceBtn.innerHTML = `Select Bug <i class="fas fa-chevron-down" style="margin-left: 10px;"></i>`;

        // Toggle Service Selection List
        selectServiceBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            
            const isVisible = serviceSelectionList.style.display === 'block';
            serviceSelectionList.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                const rect = selectServiceBtn.getBoundingClientRect();
                const cardRect = selectServiceBtn.closest('.main-card').getBoundingClientRect();
                const topOffset = rect.bottom - cardRect.top; 
                serviceSelectionList.style.top = topOffset + 10 + 'px';
            }
        });

        // Pilih Service dari List
        serviceOptions.forEach(option => {
            option.addEventListener('click', function() {
                selectedService = this.getAttribute('data-service');
                selectServiceBtn.innerHTML = `${serviceSelections[selectedService]} <i class="fas fa-chevron-down" style="margin-left: 10px;"></i>`;
                serviceSelectionList.style.display = 'none'; 
            });
        });

        // Close Service Selection List saat klik di luar
        document.addEventListener('click', function(event) {
            if (event.target !== selectServiceBtn && !serviceSelectionList.contains(event.target)) {
                serviceSelectionList.style.display = 'none';
            }
        });
        
        // Aksi Tombol Send Service
        sendServiceBtn.addEventListener('click', function() {
            const targetNumber = targetNumberInput.value.trim();

            // 1. Validasi Target Number (WAJIB DULUAN)
            if (targetNumber === '' || targetNumber.length < 8 || !/^\d+$/.test(targetNumber)) {
                if (targetNumber === '') {
                    showCustomModal('Harap masukan nomor target!', 'Input Error', true);
                } else if (!/^\d+$/.test(targetNumber)) {
                    showCustomModal('Simbol ditemukan, harap hapus simbol dan kembali masukan nomor!', 'Input Error', true);
                } else if (targetNumber.length < 8) {
                    showCustomModal('Nomor target minimal 8 digit!', 'Input Error', true);
                }
                return; // Berhenti di sini, tidak lanjut ke validasi berikutnya
            }
            
            // 2. Validasi Select Bug (SETELAH NOMOR TERISI)
            if (!selectedService) {
                showCustomModal('Pilih jenis Bug terlebih dahulu!', 'Input Error', true);
                return; // Berhenti di sini, tidak lanjut ke pengiriman
            }
            
            // 3. LOGIKA PENGIRIMAN BUG (Dijalankan hanya jika semua validasi sukses)
            const fullTarget = `+62${targetNumber}`;

            // *** Tampilkan popup sukses ***
            showCustomModal(`Successfully Sending Bug Type ${serviceSelections[selectedService]} To Target: ${fullTarget}!`, 'DONE BUGðŸ”¥', false);
            
            // Bersihkan input setelah "pengiriman" sukses
            targetNumberInput.value = '';
            selectedService = '';
            selectServiceBtn.innerHTML = `Select Bug <i class="fas fa-chevron-down" style="margin-left: 10px;"></i>`;
        });
        
        // Event Listener untuk Logout di Icon Profil
        const userIcon = document.querySelector('.header-icon');
        if (userIcon) {
            userIcon.addEventListener('click', function() {
                showCustomModal('Apakah Anda yakin ingin Logout?', 'Konfirmasi Logout');
                const modalButton = document.querySelector('#custom-modal button');
                modalButton.textContent = 'YA, LOGOUT';
                modalButton.onclick = function() {
                    closeCustomModal();
                    logout();
                };
            });
        }
    });
   </script>
 </body>
</html>
