<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparta V0.1 - Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
<style>
    /* CSS umum */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* PERBAIKAN KRITIS: Body Anti-Stuck dan Scroll */
    body { 
        background: black; 
        font-family: 'Poppins', sans-serif; 
        color: white; 
        min-height: 100vh; /* Menggantikan height: 100vh dan overflow: hidden */
        display: flex; 
        flex-direction: column;
        align-items: center; /* Menengahkan konten di layar lebar */
        position: relative; 
        padding-bottom: 70px; /* Jarak untuk Navbar fixed */
    }
    
    /* Perubahan untuk membuat konten bisa di-scroll secara internal */
    .content-container {
        flex-grow: 1; 
        overflow-y: auto; 
        padding: 0 20px 10px 20px; 
        width: 100%;
        max-width: 500px; /* NEW: Batas lebar */
        -webkit-overflow-scrolling: touch; 
    }

    /* --- Custom Header Styles --- */
    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        width: 100%;
        max-width: 500px; /* NEW */
        background: black;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.5); /* NEW */
        position: sticky; /* NEW: Agar tetap di atas saat scroll */
        top: 0; /* NEW */
        z-index: 100;
        flex-shrink: 0; 
    }

    .header-title {
        font-size: 20px;
        font-weight: 800;
        color: #1B47F1;
        text-shadow: 0 0 10px #0917D7;
    }

    .header-icon {
        font-size: 24px;
        color: #B3C0FF;
        cursor: pointer;
    }

    /* --- GIF/Video Banner Styles (Pengganti Slider) --- */
    /* Menghapus .slider-container, .slider-wrapper, .slide-item */
    .gif-banner-container {
        position: relative;
        overflow: hidden;
        border-radius: 15px;
        margin-top: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        height: auto; 
        padding-bottom: 56.25%; /* Rasio 16:9 */
        background: black; 
        flex-shrink: 0; 
    }
    
    .gif-banner-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover; 
        display: block;
    }
    
    /* Overlay untuk Beta Test Text */
    .beta-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        background: rgba(0, 0, 0, 0.4);
        color: white;
        text-align: left;
        z-index: 10; /* NEW: Pastikan di atas video */
    }
    
    .beta-overlay h3 {
        font-size: 20px;
        font-weight: 800;
        color: #1B47F1; 
        text-shadow: 0 0 5px #0917D7;
    }
    
    .beta-overlay p {
        font-size: 12px;
        color: #ccc;
    }
    
    /* --- Menu Buttons --- */
    .menu-buttons {
        display: flex;
        justify-content: space-around;
        margin: 30px 0;
        padding: 0 10px;
        flex-shrink: 0;
    }
    
    .menu-item {
        text-align: center;
        width: 25%;
    }
    
    .menu-icon-wrapper {
        width: 60px;
        height: 60px;
        margin: 0 auto 8px auto;
        border-radius: 50%;
        background: rgba(27, 71, 241, 0.1);
        border: 1px solid #1B47F1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 0 10px rgba(27, 71, 241, 0.3);
    }
    
    .menu-item:hover .menu-icon-wrapper {
        background: #1B47F1;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(27, 71, 241, 0.5);
    }
    
    .menu-icon {
        font-size: 24px;
        color: #1B47F1;
        transition: color 0.3s ease;
    }
    
    .menu-item:hover .menu-icon {
        color: white;
    }
    
    .menu-text {
        font-size: 12px;
        color: #B3C0FF;
        font-weight: 500;
    }
    
    /* --- Telegram Banner --- */
    .telegram-banner {
        background: linear-gradient(135deg, #7A09FA, #B900FF);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(185, 0, 255, 0.5);
        flex-shrink: 0;
    }
    
    .telegram-text {
        text-align: left;
    }
    
    .telegram-text h4 {
        font-size: 14px;
        font-weight: 600;
    }
    
    .telegram-text span {
        font-size: 12px;
        color: #eee;
    }
    
    .telegram-icon {
        font-size: 20px;
        color: white;
    }

    /* --- Server Stats Widget --- */
    .stats-widget {
        background: linear-gradient(145deg, #35004D, #1A0026);
        padding: 20px;
        border-radius: 15px;
        margin-top: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        color: white;
        flex-shrink: 0;
    }

    .stats-title {
        font-size: 18px;
        font-weight: 600;
        color: #1B47F1; 
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .stats-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0; 
        position: relative;
    }
    
    .stats-row::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 1px;
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(-50%);
    }

    .stats-label {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #B3C0FF;
        flex-basis: 50%; 
        text-align: left;
    }
    
    .stats-icon {
        margin-right: 10px;
        font-size: 16px;
        color: #F81CF8; 
    }
    
    .stats-value-container {
        display: flex;
        flex-basis: 50%; 
        justify-content: flex-end; 
    }
    
    .stats-value {
        font-size: 14px;
        font-weight: 800;
        color: #F81CF8; 
        text-shadow: 0 0 5px #F81CF8;
        min-width: 30px; 
        text-align: right;
    }
    
    /* --- Navbar Horizontal Styles (FIXED/BUG.HTML) --- */
    .navbar-container {
        position: fixed; /* Menggantikan flexbox lama */
        bottom: 0; /* NEW */
        left: 0; /* NEW */
        width: 100%;
        max-width: 500px; /* NEW */
        margin: 0 auto; /* NEW */
        background: #0d0d0d; 
        border-top: 3px solid #1B47F1; 
        box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.7); 
        padding: 5px 0; /* NEW */
        display: flex;
        justify-content: space-around; 
        align-items: center;
        height: 60px; /* NEW */
        z-index: 200; /* NEW */
        backdrop-filter: blur(5px);
        flex-shrink: 0; 
        padding-bottom: env(safe-area-inset-bottom, 0); /* NEW */
    }

    .nav-item {
        text-align: center;
        cursor: pointer;
        position: relative;
        min-width: 60px; 
        transition: transform 0.2s, color 0.2s;
        display: flex;
        flex-direction: column; 
        justify-content: center;
        align-items: center;
        padding: 5px; /* NEW: Sesuaikan padding */
        width: 25%; /* NEW: Bagi rata 4 item */
    }
    
    .nav-item:hover {
         transform: translateY(-2px);
    }

    .nav-icon {
        font-size: 24px;
        color: #404040; 
        transition: color 0.3s;
        margin-bottom: 4px; /* NEW */
    }

    .nav-item.active .nav-icon {
        color: #1B47F1; 
        text-shadow: 0 0 5px #1B47F1;
    }
    
    .nav-text {
        font-size: 14px; /* NEW: Ganti font size */
        font-weight: 500;
        color: #B3C0FF; 
        white-space: nowrap;
        line-height: 1.2; 
    }

    /* Modal CSS (Perbaikan Anti-Stuck) */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 99999; /* Z-Index Tinggi */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none; /* NEW: Mencegah stuck */
    }
    
    .custom-modal.show {
        opacity: 1;
        display: flex;
        pointer-events: auto; /* NEW: Aktifkan saat tampil */
    }

    .modal-content {
        background-color: #1a1a1a;
        margin: auto; /* Perbaikan margin */
        padding: 25px;
        border: 2px solid #1B47F1;
        border-radius: 12px;
        width: 90%;
        max-width: 300px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.6);
        text-align: center;
        color: white;
    }

    .modal-content h3 {
        color: #1B47F1;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .modal-content p {
        margin-bottom: 20px;
        font-size: 14px;
        color: #ccc;
    }

    .modal-button {
        background: #ff4444;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s;
    }

    .modal-button:hover {
        background: #cc3333;
    }

    /* Area mobile (supaya navbar/header tetap di tengah) */
    @media (min-width: 500px) {
        .navbar-container {
            left: 50%;
            transform: translateX(-50%);
        }
        .header-top { 
            left: 50%;
            transform: translateX(-50%);
            position: fixed; 
            top: 0;
        }
    }
</style>
</head>

<body>
    <div id="custom-modal" class="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title">Peringatan!</h3>
            <p id="modal-text">Sesi Anda telah berakhir atau akun Anda telah dihapus.</p>
            <button id="btn-logout-modal" class="modal-button">Logout dan Kembali</button>
        </div>
    </div>

    <div class="header-top">
        <div class="header-title">Sparta V0.1</div>
        <i class="fas fa-user-circle header-icon"></i>
    </div>
        
    <div class="content-container"> 
        <div class="gif-banner-container">
            <video src="media/slide.gif" autoplay loop muted playsinline></video>
            <div class="beta-overlay">
                <h3 id="welcome-message">ðŸ”¥ Beta Test</h3> 
                <p id="expiry-info">This Apps Server Still On Beta Test.</p>
            </div>
        </div>
        
        <div class="menu-buttons">
            <div class="menu-item" onclick="window.open('https://t.me/Farelmod', '_blank')">
                <div class="menu-icon-wrapper">
                    <i class="fab fa-telegram menu-icon"></i>
                </div>
                <div class="menu-text">Telegram</div>
            </div>
            <div class="menu-item" onclick="showCustomModal('Fitur Chat belum tersedia.', 'Informasi')">        
                <div class="menu-icon-wrapper">
                    <i class="fas fa-comment menu-icon"></i>
                </div>
                <div class="menu-text">Chat</div>
            </div>
            <div class="menu-item" onclick="showCustomModal('Fitur Account belum tersedia.', 'Informasi')">   
                <div class="menu-icon-wrapper">
                    <i class="fas fa-cog menu-icon"></i>
                </div>
                <div class="menu-text">Account</div>
            </div>
        </div>

        <div class="telegram-banner" onclick="window.open('https://t.me/allinfosparta', '_blank')">
            <div class="telegram-text">
                <h4>Join Telegram Channel!</h4>
                <span>Join To Get More Info!</span>
            </div>
            <i class="fa-brands fa-telegram telegram-icon"></i>
        </div>

        <div class="stats-widget">
            <div class="stats-title">
                <i class="fa-solid fa-server" style="margin-right: 8px;"></i> Status Server
            </div>
            <div class="stats-row">
                <div class="stats-label">
                    <i class="fa-solid fa-user-check stats-icon"></i> Online Users
                </div>
                <div class="stats-value-container">
                    <span id="online-users-value" class="stats-value">0</span>
                </div>
            </div>
            <div class="stats-row">
                <div class="stats-label">
                    <i class="fa-solid fa-message stats-icon"></i> Active Sender
                </div>
                <div class="stats-value-container">
                    <span id="active-sender-value" class="stats-value">0</span>
                </div>
            </div>
        </div>

        <div style="height: 20px;"></div> 

    </div> <div class="navbar-container">
        <div class="nav-item active" data-text="Home">
            <i class="fas fa-home nav-icon"></i>
            <span class="nav-text">Home</span>
        </div>
        <div class="nav-item" onclick="window.location.href='bug.html'" data-text="Bug">
            <i class="fas fa-phone-alt nav-icon"></i>
            <span class="nav-text">Bug</span>
        </div>        
        <div class="nav-item" onclick="showCustomModal('Fitur Tools belum tersedia.', 'Informasi')" data-text="Tools">
            <i class="fas fa-bolt nav-icon"></i>
            <span class="nav-text">Tools</span>
        </div>
        <div class="nav-item" onclick="showCustomModal('Fitur Chat belum tersedia.', 'Informasi')" data-text="Chat">
            <i class="fas fa-comment nav-icon"></i>
            <span class="nav-text">Chat</span>
        </div>
    </div>

    <script>
        // --- KONFIGURASI FIREBASE ANDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFqY8y8uQjyFA39m0LFt5C1qYf0AOucvU",
            authDomain: "realtime-database-projec-79515.firebaseapp.com",
            databaseURL: "https://realtime-database-projec-79515-default-rtdb.firebaseio.com",
            projectId: "realtime-database-projec-79515",
            storageBucket: "realtime-database-projec-79515.firebasestorage.app",
            messagingSenderId: "87990196443",
            appId: "1:87990196443:web:a0b11f82680276292a14fe"
        };

        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const onlineRef = db.ref('onlineUsers'); 
        
        // Konstanta Heartbeat
        const HEARTBEAT_INTERVAL = 15000; 
        const USER_TIMEOUT = 30000; 
        const CHECK_INTERVAL = 10000; 

        // --- KRITIS: Session dan Fetch Functions dari index.html ---
        const raw_aksesURL = "https://raw.githubusercontent.com/Farelmods-ux/database/main/akses.json";
        
        function clearSession() {
            localStorage.removeItem('app_session');
        }

        function getSession() {
            try {
                return JSON.parse(localStorage.getItem('app_session'));
            } catch (e) { return null; }
        }
        
        async function fetchJSON(url) {
            try {
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) throw new Error('Gagal mengambil JSON: ' + resp.status);
                const txt = await resp.text();
                let data;
                try { data = JSON.parse(txt); } catch (e) {
                    const arrMatch = txt.match(/\[([\s\S]*)\]/);
                    if (arrMatch) {
                        try { data = JSON.parse('[' + arrMatch[1] + ']'); } catch (e2) { data = null; }
                    }
                }
                if (!data) return null;
                if (Array.isArray(data)) return data;
                if (typeof data === 'object') {
                    const vals = Object.values(data).filter(v => typeof v === 'object');
                    if (vals.length) return vals;
                    return data; 
                }
                return null;
            } catch (err) {
                console.error("Error fetching JSON from " + url, err);
                return null;
            }
        }
        
        async function fetchAccessList() {
            return fetchJSON(raw_aksesURL);
        }

        // --- FUNGSI MODAL DASHBOARD (Diperbaiki agar Anti-Stuck) ---
        const customModal = document.getElementById('custom-modal');
        const modalText = document.getElementById('modal-text');
        const modalTitle = document.getElementById('modal-title');
        
        function showCustomModal(message, title = "Peringatan!") {
            const modalButton = customModal.querySelector('.modal-button');
            modalTitle.textContent = title;
            modalText.textContent = message;
            
            // Atur ulang tombol default
            modalButton.textContent = 'OK';
            modalButton.style.backgroundColor = '#1B47F1';
            modalButton.onclick = closeCustomModal;

            customModal.classList.add('show');
            customModal.style.display = 'flex';
            customModal.style.pointerEvents = 'auto';
            
            setTimeout(() => { modalButton.focus(); }, 50); 
        }

        function closeCustomModal() {
            customModal.classList.remove('show');
            customModal.style.pointerEvents = 'none';
            setTimeout(() => { customModal.style.display = 'none'; }, 300);
        }

        function performLogout() {
            const session = getSession();
            if (session && session.username) {
                 onlineRef.child(session.username).remove();
            }
            clearSession();
            window.location.href = "index.html";
        }
        
        // OLD: btnLogoutModal.addEventListener('click', function() { performLogout(); }); 
        // Hapus event listener lama di btnLogoutModal, digantikan oleh logic showCustomModal

        // NEW: Event Listener untuk Icon Profil di Header
        document.querySelector('.header-icon').addEventListener('click', function() {
            showCustomModal('Apakah Anda yakin ingin Logout?', 'Konfirmasi Logout');
            const modalButton = document.querySelector('#custom-modal .modal-button');
            modalButton.textContent = 'YA, LOGOUT';
            modalButton.style.backgroundColor = '#ff4444';
            modalButton.onclick = function() {
                closeCustomModal();
                performLogout();
            };
        });


        // --- LOGIKA REAL-TIME DELETION CHECK ---
        let checkDeletionIntervalId;

        function checkRealTimeDeletion(username) {
            checkDeletionIntervalId = setInterval(async () => {
                const list = await fetchAccessList();
                if (!list) return; 

                const found = list.find(u => u && u.username == username);

                if (!found) {
                    clearInterval(checkDeletionIntervalId);
                    clearSession();
                    onlineRef.child(username).remove();
                    showCustomModal("Akun Anda Telah Dihapus, Silahkan Beli Lagi", "Akun Dihapus!");
                    
                    const modalButton = document.querySelector('#custom-modal .modal-button');
                    modalButton.textContent = 'Logout';
                    modalButton.style.backgroundColor = '#ff4444';
                    modalButton.onclick = performLogout;
                }
            }, CHECK_INTERVAL);
        }
        
        // --- LOGIKA HEARTBEAT OTOMATIS ---
        
        function startHeartbeat(username) {
            const userRef = onlineRef.child(username);
            
            userRef.onDisconnect().remove(); 

            setInterval(() => {
                userRef.set({ 
                    lastActive: firebase.database.ServerValue.TIMESTAMP 
                });
            }, HEARTBEAT_INTERVAL); 
        }

        // --- LOGIKA UPDATE STATS REAL-TIME ---

        function setupOnlineUserListener() {
            const onlineUsersValue = document.getElementById('online-users-value');
            const activeSenderValue = document.getElementById('active-sender-value');
            
            onlineRef.on('value', (snapshot) => {
                let onlineCount = 0;
                let activeSender = 0; 
                
                const users = snapshot.val();
                const currentTime = Date.now();
                
                if (users) {
                    const userList = Object.keys(users);
                    
                    for (let username of userList) {
                        const lastActive = users[username] ? users[username].lastActive : 0;
                        
                        if (currentTime - lastActive < USER_TIMEOUT) {
                            onlineCount++;
                        }
                    }
                    
                    activeSender = Math.max(0, Math.floor(onlineCount * 0.8) + Math.floor(Math.random() * 3));
                }
                
                onlineUsersValue.textContent = onlineCount.toString();
                activeSenderValue.textContent = activeSender.toString();
            });
        }
        
        // NEW: Fungsi Helper Format Tanggal
        function formatExpiryDate(session) {
            if (!session || !session.loginAt || session.expiresAt === undefined) return 'N/A';
            
            const durasi = session.durasi ? session.durasi.toLowerCase() : '';
            
            if (durasi === 'permanent') {
                return '9999-99-99';
            }

            if (session.expiresAt !== Infinity && session.expiresAt != null) {
                const expiryDate = new Date(session.expiresAt);
                const year = expiryDate.getFullYear();
                const month = String(expiryDate.getMonth() + 1).padStart(2, '0');
                const day = String(expiryDate.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            
            return 'N/A';
        }


        // --- LOGIKA IMAGE SLIDER & NAVBAR (HAPUS SEMUA) ---
        // Menghapus semua logika slider lama di sini.

        // --- DASHBOARD ON LOAD & MASTER INITIATION ---
        document.addEventListener('DOMContentLoaded', function () {
            const session = getSession();
            
            if (!session) {
                window.location.href = "index.html";
                return;
            }

            // Tampilkan info user (Sesuai permintaan, tidak hapus welcome message lama, tapi tambahkan format baru)
            const displayUsername = session.username.charAt(0).toUpperCase() + session.username.slice(1);
            
            // Mengganti update welcome-message dan expiry-info
            document.getElementById('welcome-message').textContent = `${displayUsername} (Role: ${session.role.charAt(0).toUpperCase() + session.role.slice(1)})`;
            
            const expFormatted = formatExpiryDate(session);
            document.getElementById('expiry-info').textContent = `Masa Aktif Berakhir: ${expFormatted}`;

            // Mulai pengecekan real-time (Penghapusan Akun)
            checkRealTimeDeletion(session.username);
            
            // Gantikan logika status server lama dengan Firebase Heartbeat
            setupOnlineUserListener();
            startHeartbeat(session.username); 

            // Hapus: Inisialisasi slider goToSlide(0);
        });

    </script>
</body>
    </html>
