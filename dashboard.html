<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparta V0.1 - Dashboard</title>
    <!-- Firebase SDKs (Menggunakan versi 8.6.8 yang kompatibel dengan <script> tag) -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    
    <!-- Google Font & Icon -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
<style>
    /* CSS umum */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: black; font-family: 'Poppins', sans-serif; color: white; min-height: 100vh; position: relative; }
    .content { padding: 0 20px 100px 20px; /* Padding atas dikurangi */ }

    /* --- Custom Header Styles --- */
    .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: black;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .header-title {
        font-size: 20px;
        font-weight: 800;
        color: #1B47F1;
        text-shadow: 0 0 10px #0917D7;
    }

    .header-icon {
        font-size: 24px;
        color: #B3C0FF;
        cursor: pointer;
    }

    /* --- Image Slider (Carousel) Styles --- */
    .slider-container {
        position: relative;
        overflow: hidden;
        border-radius: 15px;
        margin-top: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        height: 0; 
        padding-bottom: 56.25%; /* Rasio 16:9 */
        background: black; 
    }

    .slider-wrapper {
        display: flex;
        transition: transform 0.3s ease-in-out;
        width: 300%; 
        position: absolute; 
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .slide-item {
        width: 100%;
        flex-shrink: 0;
        position: relative;
    }

    .slide-item img {
        width: 100%;
        height: 100%; 
        object-fit: contain; 
        display: block;
    }
    
    /* Overlay untuk Beta Test Text */
    .beta-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 15px;
        background: rgba(0, 0, 0, 0.4);
        color: white;
        text-align: left;
    }
    
    .beta-overlay h3 {
        font-size: 20px;
        font-weight: 800;
        color: #ff4444; 
        text-shadow: 0 0 5px #ff4444;
    }
    
    .beta-overlay p {
        font-size: 12px;
        color: #ccc;
    }
    
    /* --- Menu Buttons --- */
    .menu-buttons {
        display: flex;
        justify-content: space-around;
        margin: 30px 0;
        padding: 0 10px;
    }
    
    .menu-item {
        text-align: center;
        width: 25%;
    }
    
    .menu-icon-wrapper {
        width: 60px;
        height: 60px;
        margin: 0 auto 8px auto;
        border-radius: 50%;
        background: rgba(27, 71, 241, 0.1);
        border: 1px solid #1B47F1;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 0 10px rgba(27, 71, 241, 0.3);
    }
    
    .menu-item:hover .menu-icon-wrapper {
        background: #1B47F1;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(27, 71, 241, 0.5);
    }
    
    .menu-icon {
        font-size: 24px;
        color: #1B47F1;
        transition: color 0.3s ease;
    }
    
    .menu-item:hover .menu-icon {
        color: white;
    }
    
    .menu-text {
        font-size: 12px;
        color: #B3C0FF;
        font-weight: 500;
    }
    
    /* --- Telegram Banner --- */
    .telegram-banner {
        background: linear-gradient(135deg, #7A09FA, #B900FF);
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(185, 0, 255, 0.5);
    }
    
    .telegram-text {
        text-align: left;
    }
    
    .telegram-text h4 {
        font-size: 14px;
        font-weight: 600;
    }
    
    .telegram-text span {
        font-size: 12px;
        color: #eee;
    }
    
    .telegram-icon {
        font-size: 20px;
        color: white;
    }

    /* --- Server Stats Widget --- */
    .stats-widget {
        background: linear-gradient(145deg, #35004D, #1A0026);
        padding: 20px;
        border-radius: 15px;
        margin-top: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        color: white;
    }

    .stats-title {
        font-size: 18px;
        font-weight: 600;
        color: #1B47F1; 
        margin-bottom: 15px;
        display: flex;
        align-items: center;
    }
    
    .stats-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0; 
        position: relative;
    }
    
    .stats-row::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 0;
        bottom: 0;
        width: 1px;
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(-50%);
    }

    .stats-label {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #B3C0FF;
        flex-basis: 50%; 
        text-align: left;
    }
    
    .stats-icon {
        margin-right: 10px;
        font-size: 16px;
        color: #F81CF8; 
    }
    
    .stats-value-container {
        display: flex;
        flex-basis: 50%; 
        justify-content: flex-end; 
    }
    
    .stats-value {
        font-size: 14px;
        font-weight: 800;
        color: #F81CF8; 
        text-shadow: 0 0 5px #F81CF8;
        min-width: 30px; 
        text-align: right;
    }
    
    /* --- Navbar Horizontal Styles --- */
    .navbar-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #0d0d0d; 
        border-top: 3px solid #1B47F1; 
        box-shadow: 0 -8px 20px rgba(0, 0, 0, 0.7); 
        padding: 5px 0;
        display: flex;
        justify-content: space-around; 
        align-items: center;
        z-index: 50;
        backdrop-filter: blur(5px);
    }

    .nav-item {
        text-align: center;
        cursor: pointer;
        position: relative;
        min-width: 60px; 
        transition: transform 0.2s, color 0.2s;
        display: flex;
        flex-direction: column; 
        justify-content: center;
        align-items: center;
        padding: 0; 
    }
    
    .nav-item:hover {
         transform: translateY(-2px);
    }

    .nav-icon {
        font-size: 24px;
        color: #404040; 
        transition: color 0.3s;
    }

    .nav-item.active .nav-icon {
        color: #1B47F1; 
        text-shadow: 0 0 5px #1B47F1;
    }
    
    .nav-text {
        position: static; 
        transform: none;
        font-size: 14px; 
        font-weight: 500;
        color: #B3C0FF; 
        background: none; 
        padding: 0; 
        border-radius: 0; 
        display: block; 
        white-space: nowrap;
        box-shadow: none;
        z-index: 60;
        line-height: 1.2; 
        margin-top: 2px; 
    }

    /* --- Modal CSS --- */
    .custom-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .custom-modal.show {
        opacity: 1;
        display: flex; /* Ganti display agar transisi opacity bekerja */
    }

    .modal-content {
        background-color: #1a1a1a;
        margin: 15% auto;
        padding: 25px;
        border: 2px solid #1B47F1;
        border-radius: 12px;
        width: 90%;
        max-width: 300px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.6);
        text-align: center;
        color: white;
    }

    .modal-content h3 {
        color: #1B47F1;
        margin-bottom: 15px;
        font-size: 18px;
    }

    .modal-content p {
        margin-bottom: 20px;
        font-size: 14px;
        color: #ccc;
    }

    .modal-button {
        background: #ff4444;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.3s;
    }

    .modal-button:hover {
        background: #cc3333;
    }
</style>
</head>

<body>
    <!-- Modal -->
    <div id="custom-modal" class="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title">Peringatan!</h3>
            <p id="modal-text">Sesi Anda telah berakhir atau akun Anda telah dihapus.</p>
            <button id="btn-logout-modal" class="modal-button">Logout dan Kembali</button>
        </div>
    </div>

    <div class="header-top">
        <div class="header-title">Sparta V0.1</div>
        <i class="fas fa-user-circle header-icon"></i>
    </div>

    <div class="content">
        <!-- Selamat Datang Section -->
        <div style="margin-bottom: 30px;">
            <p id="welcome-message" class="welcome" style="font-size: 20px; font-weight: 600;"></p>
            <p id="expiry-info" class="user-info" style="font-size: 14px; margin-top: 5px;"></p>
        </div>

        <!-- Image Slider -->
        <div id="image-slider" class="slider-container">
            <div class="slider-wrapper">
                <div class="slide-item">
                    <img src="https://placehold.co/800x450/1B47F1/ffffff?text=Slide+1" onerror="this.src='https://placehold.co/800x450/1B47F1/ffffff?text=Slide+1'" alt="Slider Image 1">
                    <div class="beta-overlay">
                        <h3>ðŸ”¥ Beta Test</h3>
                        <p>This  Apps  Server  Still  On  Beta  Test.</p>                   
                    </div>
                </div>
                <div class="slide-item">
                    <img src="https://placehold.co/800x450/7A09FA/ffffff?text=Slide+2" onerror="this.src='https://placehold.co/800x450/7A09FA/ffffff?text=Slide+2'" alt="Slider Image 2">
                </div>
                <div class="slide-item">
                    <img src="https://placehold.co/800x450/F81CF8/ffffff?text=Slide+3" onerror="this.src='https://placehold.co/800x450/F81CF8/ffffff?text=Slide+3'" alt="Slider Image 3">
                </div>
            </div>
        </div>

        <!-- Menu Buttons -->
        <div class="menu-buttons">
                    <div class="menu-item" onclick="window.open('https://wa.me/628123456789', '_blank')">
                <div class="menu-icon-wrapper">
                    <i class="fab fa-whatsapp menu-icon"></i>
                </div>
                <div class="menu-text">WhatsApp</div>
            </div>
            <div class="menu-item" onclick="alert('Membuka Chat (Fitur belum tersedia)')">
                <div class="menu-icon-wrapper">
                    <i class="fas fa-comment menu-icon"></i>
                </div>
                <div class="menu-text">Chat</div>
            </div>
            <div class="menu-item" onclick="alert('Membuka Akun (Fitur belum tersedia)')">
                <div class="menu-icon-wrapper">
                    <i class="fas fa-cog menu-icon"></i>
                </div>
                <div class="menu-text">Account</div>
            </div>
        </div>

        <!-- Telegram Banner -->
        <div class="telegram-banner" onclick="window.open('https://t.me/yourtelegramchannel', '_blank')">
            <div class="telegram-text">
                <h4>Join Telegram Channel!</h4>
                <span>Join To Get More Info!</span>
            </div>
            <i class="fa-brands fa-telegram telegram-icon"></i>
        </div>

        <!-- Server Stats Widget (Penghitung Real-time) -->
        <div class="stats-widget">
            <div class="stats-title">
                <i class="fas fa-chart-bar" style="margin-right: 10px;"></i> Server Stats</div>            
            </div>
            <div class="stats-row">
                <div class="stats-label">
                    <i class="fas fa-users stats-icon" style="color:#1B47F1;"></i> Online Users
                </div>
                <div class="stats-value-container">
                    <!-- ID ini akan diupdate secara real-time oleh Firebase -->
                    <span id="online-users-value" class="stats-value">0</span>
                </div>
            </div>
            <div class="stats-row">
                <div class="stats-label">
                    <i class="fas fa-rocket stats-icon" style="color:#ff4444;"></i> Active Sender
                </div>
                <div class="stats-value-container">
                    <!-- ID ini juga akan diupdate (Simulasi) -->
                    <span id="active-sender-value" class="stats-value">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar Bawah -->
    <div class="navbar-container">
            <div class="nav-item active" id="nav-home">
            <i class="fas fa-home nav-icon"></i>
            <div class="nav-text">Home</div>
        </div>
        
        <div class="nav-item" id="nav-bug">
            <i class="fas fa-phone-alt nav-icon"></i>
            <div class="nav-text">Bug</div>
        </div>

        <div class="nav-item" id="nav-update">
            <i class="fas fa-bolt nav-icon"></i>
            <div class="nav-text">Update</div>
        </div>

        <div class="nav-item" id="nav-chat">
            <i class="fas fa-comment nav-icon"></i>
            <div class="nav-text">Chat</div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI FIREBASE ANDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyDFqY8y8uQjyFA39m0LFt5C1qYf0AOucvU",
            authDomain: "realtime-database-projec-79515.firebaseapp.com",
            databaseURL: "https://realtime-database-projec-79515-default-rtdb.firebaseio.com",
            projectId: "realtime-database-projec-79515",
            storageBucket: "realtime-database-projec-79515.firebasestorage.app",
            messagingSenderId: "87990196443",
            appId: "1:87990196443:web:a0b11f82680276292a14fe"
        };

        // Inisialisasi Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const onlineRef = db.ref('onlineUsers'); // Node khusus di Realtime Database
        
        // Konstanta Heartbeat
        const HEARTBEAT_INTERVAL = 15000; // Kirim heartbeat setiap 15 detik
        const USER_TIMEOUT = 30000; // User dianggap offline jika tidak ada heartbeat selama 30 detik
        const CHECK_INTERVAL = 10000; // Interval cek hapus akun

        // --- KRITIS: Session dan Fetch Functions dari index.html ---
        // URL sumber data akses (Sama seperti di index.html)
        const RAW_URL_AKSES = "https://raw.githubusercontent.com/Farelmods-ux/database/main/akses.json";
        
        function clearSession() {
            localStorage.removeItem('app_session');
        }

        function getSession() {
            try {
                return JSON.parse(localStorage.getItem('app_session'));
            } catch (e) { return null; }
        }
        
        // Fungsi fetch JSON dari index.html
        async function fetchJSON(url) {
            try {
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) throw new Error('Gagal mengambil JSON: ' + resp.status);
                const txt = await resp.text();
                let data;
                try { data = JSON.parse(txt); } catch (e) {
                    const arrMatch = txt.match(/\[([\s\S]*)\]/);
                    if (arrMatch) {
                        try { data = JSON.parse('[' + arrMatch[1] + ']'); } catch (e2) { data = null; }
                    }
                }
                if (!data) return null;
                if (Array.isArray(data)) return data;
                if (typeof data === 'object') {
                    const vals = Object.values(data).filter(v => typeof v === 'object');
                    if (vals.length) return vals;
                    return data; 
                }
                return null;
            } catch (err) {
                console.error("Error fetching JSON from " + url, err);
                return null;
            }
        }
        
        async function fetchAccessList() {
            return fetchJSON(RAW_URL_AKSES);
        }

        // --- FUNGSI MODAL DASHBOARD ---
        const customModal = document.getElementById('custom-modal');
        const modalText = document.getElementById('modal-text');
        const modalTitle = document.getElementById('modal-title');
        const btnLogoutModal = document.getElementById('btn-logout-modal');

        function showCustomModal(message, title = "Peringatan!") {
            modalTitle.textContent = title;
            modalText.textContent = message;
            customModal.style.display = 'flex';
            // Paksa reflow untuk transisi opacity
            setTimeout(() => customModal.classList.add('show'), 10);
            
            // Nonaktifkan interaksi di body kecuali modal
            document.body.style.pointerEvents = 'none';
            customModal.style.pointerEvents = 'auto';
        }

        function performLogout() {
            const session = getSession();
            // Hapus user dari online list saat logout (penting!)
            if (session && session.username) {
                 onlineRef.child(session.username).remove();
            }
            clearSession();
            window.location.href = "index.html";
        }
        
        btnLogoutModal.addEventListener('click', function() {
            performLogout();
        });


        // --- LOGIKA REAL-TIME DELETION CHECK ---
        let checkDeletionIntervalId;

        function checkRealTimeDeletion(username) {
            checkDeletionIntervalId = setInterval(async () => {
                const list = await fetchAccessList();
                if (!list) return; 

                // Cek apakah username masih ada di list akses
                const found = list.find(u => (u.username == username));

                if (!found) {
                    clearInterval(checkDeletionIntervalId);
                    clearSession();
                    // Hapus data online saat akun dihapus
                    onlineRef.child(username).remove();
                    showCustomModal("Akun Anda Telah Dihapus, Silahkan Beli Lagi", "Akun Dihapus!");
                }
            }, CHECK_INTERVAL);
        }
        
        // --- LOGIKA HEARTBEAT OTOMATIS (FIREBASE) ---
        
        function startHeartbeat(username) {
            const userRef = onlineRef.child(username);
            
            // 1. Set onDisconnect: Hapus data jika user menutup browser/tab secara tiba-tiba
            userRef.onDisconnect().remove(); 

            // 2. Kirim "Heartbeat" (timestamp server) secara berkala
            setInterval(() => {
                userRef.set({ 
                    lastActive: firebase.database.ServerValue.TIMESTAMP 
                });
            }, HEARTBEAT_INTERVAL); 
        }

        // --- LOGIKA UPDATE STATS (Mendengarkan Realtime Database) ---

        function setupOnlineUserListener() {
            const onlineUsersValue = document.getElementById('online-users-value');
            const activeSenderValue = document.getElementById('active-sender-value');
            
            // Dengarkan perubahan data di node 'onlineUsers' secara Real-time
            onlineRef.on('value', (snapshot) => {
                let onlineCount = 0;
                let activeSender = 0; 
                
                const users = snapshot.val();
                const currentTime = Date.now();
                
                if (users) {
                    const userList = Object.keys(users);
                    
                    // Hitung user yang lastActive-nya masih dalam batas waktu 30 detik
                    for (let username of userList) {
                        const lastActive = users[username].lastActive || 0;
                        
                        // User dianggap online jika heartbeat kurang dari USER_TIMEOUT
                        if (currentTime - lastActive < USER_TIMEOUT) {
                            onlineCount++;
                        }
                    }
                    
                    // Simulasikan Active Sender: 80% dari Online Users + random kecil
                    activeSender = Math.max(0, Math.floor(onlineCount * 0.8) + Math.floor(Math.random() * 3));
                }
                
                // Update tampilan
                onlineUsersValue.textContent = onlineCount.toString();
                activeSenderValue.textContent = activeSender.toString();
            });
        }

        // --- LOGIKA IMAGE SLIDER & NAVBAR (Tidak Berubah) ---
        const slider = document.getElementById('image-slider');
        const sliderWrapper = slider.querySelector('.slider-wrapper');
        const totalSlides = sliderWrapper.querySelectorAll('.slide-item').length;
        let currentSlide = 0;

        function goToSlide(index) {
            if (index >= totalSlides) { index = 0; }
            if (index < 0) { index = totalSlides - 1; }
            currentSlide = index;
            const offset = (-currentSlide * 100) / totalSlides;
            sliderWrapper.style.transform = `translateX(${offset}%)`; 
        }

        setInterval(() => {
            goToSlide(currentSlide + 1);
        }, 5000);
        
        let startX = 0;
        let endX = 0;
        
        slider.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            sliderWrapper.style.transition = 'none'; 
        });
        
        slider.addEventListener('touchmove', (e) => {
            endX = e.touches[0].clientX;
            const diff = endX - startX;
            const currentOffset = -currentSlide * slider.offsetWidth;
            sliderWrapper.style.transform = `translateX(${currentOffset + diff}px)`;
        });
        
        slider.addEventListener('touchend', () => {
            const diff = endX - startX;
            const threshold = 50; 
            sliderWrapper.style.transition = 'transform 0.3s ease-in-out'; 
            
            if (diff > threshold) {
                goToSlide(currentSlide - 1);
            } else if (diff < -threshold) {
                goToSlide(currentSlide + 1);
            } else {
                goToSlide(currentSlide);
            }
        });


        // LOGIKA NAVBAR
        const navItems = document.querySelectorAll('.nav-item');

        function setActiveNavItem(clickedItem) {
            navItems.forEach(item => {
                item.classList.remove('active');
            });
            clickedItem.classList.add('active');
            
 /*           // Logika khusus untuk tombol Logout (memunculkan modal)
            if (clickedItem.getAttribute('data-text') === 'Logout') {
                 showCustomModal('Apakah Anda yakin ingin logout?', 'Konfirmasi Logout');
            } else {
                // Di sini Anda bisa menambahkan logika untuk memuat konten dashboard yang berbeda
                console.log(`Menu diklik: ${clickedItem.getAttribute('data-text')}`);
            }
        }*/

        navItems.forEach(item => {
            item.addEventListener('click', function() {
                setActiveNavItem(this);
            });
        });


        // --- DASHBOARD ON LOAD & MASTER INITIATION ---
        document.addEventListener('DOMContentLoaded', function () {
            const session = getSession();
            
            if (!session) {
                window.location.href = "index.html";
                return;
            }

            // Tampilkan info user
            const displayUsername = session.username.charAt(0).toUpperCase() + session.username.slice(1);
            document.getElementById('welcome-message').textContent = `Selamat Datang, ${displayUsername}!`;
            
            if (session.expiresAt !== Infinity) {
                const roleText = session.role === 'owner' ? ' Owner' : '';
                const expiryDate = new Date(session.expiresAt).toLocaleDateString('id-ID', {day: 'numeric', month: 'numeric', year: 'numeric'});
                document.getElementById('expiry-info').textContent = `Masa Aktif: ${session.durasi}${roleText} (berakhir ${expiryDate})`;
            } else {
                const roleText = session.role === 'owner' ? ' Owner' : '';
                document.getElementById('expiry-info').textContent = `Masa Aktif: Permanent${roleText} (Tidak akan dihapus)`;
            }

            // Mulai pengecekan real-time (Penghapusan Akun)
            checkRealTimeDeletion(session.username);
            
            // Mulai logika Heartbeat dan Listener Online User (OTOMATIS)
            setupOnlineUserListener();
            startHeartbeat(session.username); 

            // Inisialisasi slider
            goToSlide(0);
        });

    </script>
</body>
    </html>
